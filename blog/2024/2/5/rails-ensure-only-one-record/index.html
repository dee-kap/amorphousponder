<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Handling Single Record Queries in Rails with Grace</title><meta name=description content="Personal website of Deepak."><link rel=alternate href=feed/feed.xml type=application/atom+xml title="Amorphous Ponder"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin=""><link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&display=swap" rel=stylesheet><style>:root{--font-family:&quot;--syntax-tab-size:2;--background-color:#eff1f5;--text-color:#4c4f69;--color-border-header:#dc8a78;--color-green:#94e2d5;--color-blue:#1e66f5;--color-mauve:#8839ef;--color-yellow:#df8e1d;--color-lavender:#7287fd;--color-surface0:#ccd0da;--color-surface1:#bcc0cc;--color-peach:#fe640b}#theme-toggle{background-color:var(--background-color);color:#000;border:none;font-size:2em}[data-theme=dark]{--background-color:#1e1e2e;--text-color:#cdd6f4;--color-border-header:#f5e0dc;--color-green:#a6e3a1;--color-blue:#89b4fa;--color-mauve:#cba6f7;--color-yellow:#f9e2af;--color-lavender:#b4befe;--color-surface0:#313244;--color-surface1:#45475a;--color-peach:#fab387;color:#fff}body{max-width:720px;margin:0 auto;padding:5px;font-family:var(--font-family);background-color:var(--background-color);color:var(--text-color);font-size:107%}a{position:relative;color:var(--color-blue);overflow:hidden}a:visited{color:var(--color-blue)}a:focus,a:hover{color:var(--color-peach)}h1,h2,h3,h4,h5,h6{color:var(--color-mauve)}blockquote{background-color:var(--color-surface0);border-left:3px solid var(--color-peach);padding-left:10px;padding-right:10px;padding-top:4px;padding-bottom:4px;font-style:italic;text-align:left}code{font-size:90%!important}.home-link{font-size:1.5em;font-weight:700}header{display:flex;align-items:center;padding-top:10px;padding-bottom:15px;border-bottom:1px dashed var(--color-border-header)}header a{color:var(--color-mauve)}header a:visited{color:var(--color-mauve)}header a:focus,header a:hover{color:var(--color-mauve)}nav{display:flex;flex-grow:1;justify-content:end}.nav{display:flex;list-style:none}.nav-item{display:inline-block;margin-right:.5rem}.nav a[href][aria-current=page]{text-decoration:underline}.home-intro{margin-top:2em;margin-bottom:4em}img{max-width:100%;height:auto}mark{background:var(--color-green);padding:4px;border-radius:3px}main{padding:5px}p{line-height:1.9;text-align:justify}li{line-height:1.9}.postlist{list-style:none;padding:0;padding-left:1.5rem}.postlist-item{align-items:baseline;counter-increment:start-from -1;margin-bottom:1em}.postlist-item:before{display:inline-block;pointer-events:none;content:&quot;text-align:right;margin-left:-1.5rem}.postlist-date,.postlist-item:before{font-size:.8125em;color:var(--color-gray-90)}.postlist-date{word-spacing:-0.5px}.postlist-link{display:inline;font-size:1.1875em;font-weight:700;padding-left:.25em;padding-right:.5em;text-underline-position:from-font;text-underline-offset:0;text-decoration-thickness:1px}.postlist-item-active .postlist-link{font-weight:700}.post-tag{display:inline-flex;align-items:center;justify-content:center;text-transform:capitalize;font-style:italic}.post-metadata{display:inline-flex;flex-wrap:wrap;gap:.5em;list-style:none;padding:0;margin:0}.post-metadata time{margin-right:1em}.links-nextprev{display:flex;justify-content:space-between;gap:.5em 1em;list-style:&quot;padding:1em 0;margin-top:3em}.links-nextprev-next{text-align:right}.book-in-post-left{float:left;margin-top:5px;margin-right:15px;width:100px;height:150px}.books-list{display:flex;flex-wrap:wrap;gap:15px;padding-top:24px;justify-content:center}.books-list-heading{display:flex;flex-direction:column;align-items:baseline;background-color:var(--color-surface0);padding:1em;border-radius:3px}.books-list .book{position:relative;width:100px;height:150px;margin-bottom:8px;background-size:cover;background-position:center;border-radius:3px;border:3px solid var(--color-lavender)}.six-star-book{border:3px solid var(--color-green)!important}.books-list .book:hover{border-color:var(--color-yellow);box-shadow:0 0 10px 5px var(--color-yellow)}.book-title{position:absolute;bottom:0;left:0;display:flex;flex-direction:column;justify-content:flex-end;padding-bottom:5px;width:100%;height:25%;background:rgba(0,0,0,.5);color:#fff;text-align:center;font-size:12px;font-weight:700}.books-list .book:hover .book-title{color:var(--color-blue)}.book-rating{font-size:14px;margin-top:5px}.book-rating-in-post{font-size:20px}.star{color:#ccc;opacity:.6;text-shadow:0 0 1px #666}.star.filled{color:gold;opacity:1;text-shadow:none}.star.filled.six{color:#dc143c;font-size:1.25em;-webkit-text-stroke:1px #ffd700}.other-links{padding:1rem;border:1px solid var(--color-blue);border-radius:5px}.other-links .heading{display:flex;justify-content:center;padding-bottom:1rem;border-bottom:1px solid var(--color-border-header);font-size:bold}nav[aria-label=breadcrumb]{display:flex;justify-content:left!important}nav[aria-label=breadcrumb] ol{display:flex;justify-content:left!important;margin:0;padding:0}nav[aria-label=breadcrumb] li{display:inline}.tag-cloud{display:flex;flex-wrap:wrap;gap:.5rem}.tag-cloud .tag{text-decoration:none;font-weight:700}</style><script>function shuffleArray(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("theme-toggle"),e=localStorage.getItem("theme")||"dark";e&&document.documentElement.setAttribute("data-theme",e),t.addEventListener("click",(()=>{const t="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t)}))}))</script><link href=//prismjs.catppuccin.com/mocha.css rel=stylesheet></head><body><header><a href=/ class=home-link>Amorphous Ponder</a><nav><ul class=nav><li class=nav-item><a href=/blog>Blg</a></li><li class=nav-item><a href=/books>Bks</a></li><li class=nav-item><a href=/projects>Prj</a></li><li class=nav-item><a href=/pages>Pjs</a></li></ul></nav><button id=theme-toggle aria-label="Toggle theme">‚óè</button></header><main id=skip><heading-anchors><p>In Ruby on Rails, when dealing with database queries, there are instances where we anticipate a query to return a single record. This expectation arises in scenarios where the uniqueness of a record is integral to the application's logic. However, databases can sometimes contain duplicates or multiple records that meet the query criteria, leading to potential conflicts or unexpected behavior in our application. To ensure robust and error-free application behavior, it's essential to handle these cases effectively.</p><p>Consider a scenario where we query the Book model for all its records:</p><pre class=language-ruby tabindex=0><code class=language-ruby>irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">018</span><span class="token operator">></span> Book<span class="token punctuation">.</span>all
  Book Load <span class="token punctuation">(</span><span class="token number">0.1</span>ms<span class="token punctuation">)</span>  <span class="token constant">SELECT</span> <span class="token string-literal"><span class="token string">"books"</span></span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token constant">FROM</span> <span class="token string-literal"><span class="token string">"books"</span></span> <span class="token operator">/</span><span class="token operator">*</span> loading <span class="token keyword">for</span> pp <span class="token operator">*</span><span class="token operator">/</span> <span class="token constant">LIMIT</span> <span class="token operator">?</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"LIMIT"</span></span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">=></span>
<span class="token punctuation">[</span><span class="token comment">#&lt;Book:0x000000010e29cbd8</span>
  <span class="token symbol">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token symbol">title</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">,</span>
  <span class="token symbol">price</span><span class="token operator">:</span> <span class="token number">0.1599e2</span><span class="token punctuation">,</span>
  <span class="token symbol">created_at</span><span class="token operator">:</span> Wed<span class="token punctuation">,</span> <span class="token number">17</span> Jan <span class="token number">2024</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">46.668892000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">updated_at</span><span class="token operator">:</span> Wed<span class="token punctuation">,</span> <span class="token number">17</span> Jan <span class="token number">2024</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">26.612252000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">published_date</span><span class="token operator">:</span> <span class="token keyword">nil</span><span class="token operator">></span><span class="token punctuation">,</span>
 <span class="token comment">#&lt;Book:0x000000010e29ca98</span>
  <span class="token symbol">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token symbol">title</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Dracula"</span></span><span class="token punctuation">,</span>
  <span class="token symbol">price</span><span class="token operator">:</span> <span class="token number">0.2299e2</span><span class="token punctuation">,</span>
  <span class="token symbol">created_at</span><span class="token operator">:</span> Wed<span class="token punctuation">,</span> <span class="token number">17</span> Jan <span class="token number">2024</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">08.507102000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">updated_at</span><span class="token operator">:</span> Wed<span class="token punctuation">,</span> <span class="token number">17</span> Jan <span class="token number">2024</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">08.507102000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">published_date</span><span class="token operator">:</span> <span class="token keyword">nil</span><span class="token operator">></span><span class="token punctuation">,</span>
 <span class="token comment">#&lt;Book:0x000000010e29c958</span>
  <span class="token symbol">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token symbol">title</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">,</span>
  <span class="token symbol">price</span><span class="token operator">:</span> <span class="token number">0.2299e2</span><span class="token punctuation">,</span>
  <span class="token symbol">created_at</span><span class="token operator">:</span> Mon<span class="token punctuation">,</span> <span class="token number">05</span> Feb <span class="token number">2024</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">12.511819000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">updated_at</span><span class="token operator">:</span> Mon<span class="token punctuation">,</span> <span class="token number">05</span> Feb <span class="token number">2024</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">12.511819000</span> <span class="token constant">UTC</span> <span class="token operator">+</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>
  <span class="token symbol">published_date</span><span class="token operator">:</span> <span class="token keyword">nil</span><span class="token operator">></span><span class="token punctuation">]</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">019</span><span class="token operator">></span></code></pre><p>In this example, we retrieve multiple Book records. While this direct fetch is straightforward for multiple records, complications arise when our logic expects only a single record in return.</p><h3 id=the-challenge-of-ensuring-uniqueness>The Challenge of Ensuring Uniqueness</h3><p>Suppose we want to fetch a book by its title, expecting that title to be unique. However, if our database has multiple entries for the same title, this assumption breaks, and our application might behave unpredictably.</p><p>To tackle this, we could write a method like get_book:</p><pre class=language-ruby tabindex=0><code class=language-ruby><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">get_book</span></span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    books <span class="token operator">=</span> Book<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token symbol">title</span><span class="token operator">:</span> title<span class="token punctuation">)</span>
    <span class="token keyword">raise</span> ActiveRecord<span class="token double-colon punctuation">::</span>RecordNotUnique <span class="token keyword">if</span> books<span class="token punctuation">.</span>many<span class="token operator">?</span>

    <span class="token keyword">return</span> books<span class="token punctuation">.</span>first
<span class="token keyword">end</span></code></pre><p>This method fetches all books matching the given title and raises an exception if more than one record is found, effectively enforcing our uniqueness constraint. Here's how it behaves:</p><pre class=language-ruby tabindex=0><code class=language-ruby>irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">040</span><span class="token operator">></span> get_book<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">)</span>
  Book Count <span class="token punctuation">(</span><span class="token number">0.4</span>ms<span class="token punctuation">)</span>  <span class="token constant">SELECT</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> <span class="token punctuation">(</span><span class="token constant">SELECT</span> <span class="token number">1</span> <span class="token constant">AS</span> one <span class="token constant">FROM</span> <span class="token string-literal"><span class="token string">"books"</span></span> <span class="token constant">WHERE</span> <span class="token string-literal"><span class="token string">"books"</span></span><span class="token punctuation">.</span><span class="token string-literal"><span class="token string">"title"</span></span> <span class="token operator">=</span> <span class="token operator">?</span> <span class="token constant">LIMIT</span> <span class="token operator">?</span><span class="token punctuation">)</span> subquery_for_count  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"title"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"LIMIT"</span></span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>irb<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">35</span><span class="token symbol">:in</span> `get_book'<span class="token operator">:</span> ActiveRecord<span class="token double-colon punctuation">::</span>RecordNotUnique <span class="token punctuation">(</span>ActiveRecord<span class="token double-colon punctuation">::</span>RecordNotUnique<span class="token punctuation">)</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">041</span><span class="token operator">></span></code></pre><h3 id=a-more-elegant-solution-with-sole>A More Elegant Solution with .sole</h3><p>While the above method works, Rails offers a cleaner, more idiomatic way to achieve the same result with the .sole method. This method is designed to return a single record and automatically raises an ActiveRecord::SoleRecordExceeded exception if more than one record matches the query, simplifying our approach:</p><p>The get_book method can be shortened to this</p><pre class=language-ruby tabindex=0><code class=language-ruby><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">get_book</span></span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
    Book<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token symbol">title</span><span class="token operator">:</span> title<span class="token punctuation">)</span><span class="token punctuation">.</span>sole
<span class="token keyword">end</span></code></pre><pre class=language-ruby tabindex=0><code class=language-ruby>irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">045</span><span class="token operator">></span> get_book<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">)</span>
  Book Load <span class="token punctuation">(</span><span class="token number">0.4</span>ms<span class="token punctuation">)</span>  <span class="token constant">SELECT</span> <span class="token string-literal"><span class="token string">"books"</span></span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token constant">FROM</span> <span class="token string-literal"><span class="token string">"books"</span></span> <span class="token constant">WHERE</span> <span class="token string-literal"><span class="token string">"books"</span></span><span class="token punctuation">.</span><span class="token string-literal"><span class="token string">"title"</span></span> <span class="token operator">=</span> <span class="token operator">?</span> <span class="token constant">ORDER</span> <span class="token constant">BY</span> <span class="token string-literal"><span class="token string">"books"</span></span><span class="token punctuation">.</span><span class="token string-literal"><span class="token string">"id"</span></span> <span class="token constant">ASC</span> <span class="token constant">LIMIT</span> <span class="token operator">?</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"title"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"Catcher in The Rye"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"LIMIT"</span></span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">/</span>Users<span class="token regex-literal"><span class="token regex">/deepak/</span></span><span class="token punctuation">.</span>rbenv<span class="token operator">/</span>versions<span class="token operator">/</span><span class="token number">3.2</span><span class="token number">.2</span><span class="token operator">/</span>lib<span class="token operator">/</span>ruby<span class="token operator">/</span>gems<span class="token operator">/</span><span class="token number">3.2</span><span class="token number">.0</span><span class="token operator">/</span>gems<span class="token operator">/</span>activerecord<span class="token operator">-</span><span class="token number">7.1</span><span class="token number">.3</span><span class="token operator">/</span>lib<span class="token operator">/</span>active_record<span class="token operator">/</span>relation<span class="token operator">/</span>finder_methods<span class="token punctuation">.</span>rb<span class="token operator">:</span><span class="token number">141</span><span class="token symbol">:in</span> `sole'<span class="token operator">:</span> Wanted only one Book <span class="token punctuation">(</span>ActiveRecord<span class="token double-colon punctuation">::</span>SoleRecordExceeded<span class="token punctuation">)</span></code></pre><p>This approach is not only cleaner but also more efficient, as it communicates our intent more clearly and leverages Rails' built-in mechanisms for enforcing record uniqueness.</p><ul class=post-metadata><li><a href=/tags/tech/ class=post-tag>Tech</a>,</li><li><a href=/tags/ruby/ class=post-tag>Ruby</a>,</li><li><a href=/tags/ror/ class=post-tag>RoR</a></li></ul><ul class=links-nextprev><li class=links-nextprev-prev>‚Üê Previous<br><a href=/blog/2024/2/1/great-books-of-western-world/ >The Great Books of Western World</a></li><li class=links-nextprev-next>Next ‚Üí<br><a href=/blog/2024/2/5/typescript-7-tips/ >7 Essentials for Learning TypeScript</a></li></ul></heading-anchors></main><hr><h2 id=tags>Tags</h2><div class=tag-cloud><a href=/tags/tech class=tag style=font-size:1.75em>Tech </a><a href=/tags/blogging class=tag style=font-size:1em>Blogging </a><a href=/tags/aws class=tag style=font-size:.9500000000000001em>AWS </a><a href=/tags/python class=tag style=font-size:1.15em>Python </a><a href=/tags/vim class=tag style=font-size:.9500000000000001em>VIM </a><a href=/tags/fastapi class=tag style=font-size:.9500000000000001em>FastAPI </a><a href=/tags/mac class=tag style=font-size:.9500000000000001em>Mac </a><a href=/tags/hardware class=tag style=font-size:.9500000000000001em>Hardware </a><a href=/tags/react class=tag style=font-size:.9500000000000001em>React </a><a href=/tags/javascript class=tag style=font-size:1.05em>JavaScript </a><a href=/tags/ruby class=tag style=font-size:1.05em>Ruby </a><a href=/tags/books class=tag style=font-size:1.05em>Books </a><a href=/tags/gbww class=tag style=font-size:1em>GBWW </a><a href=/tags/ror class=tag style=font-size:.9500000000000001em>RoR </a><a href=/tags/typescript class=tag style=font-size:.9500000000000001em>TypeScript </a><a href=/tags/personal class=tag style=font-size:1.1em>Personal </a><a href=/tags/work class=tag style=font-size:.9500000000000001em>Work </a><a href=/tags/career class=tag style=font-size:.9500000000000001em>Career </a><a href=/tags/algorithms class=tag style=font-size:.9500000000000001em>Algorithms </a><a href=/tags/productivity class=tag style=font-size:.9500000000000001em>Productivity </a><a href=/tags/australia class=tag style=font-size:1em>Australia</a></div><footer style=margin-top:4rem;margin-bottom:4rem;font-size:80%><hr style=margin-bottom:.5rem><div style=display:flex;gap:.5rem><a href=/blog>Blog</a> |<a href=/books>Books</a> | <a href=/projects>Projects</a> | <a href=/pages>Pages</a></div></footer><script type=module src=/dist/rJ3_G-2ArF.js></script></body></html>